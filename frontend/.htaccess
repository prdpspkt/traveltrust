# ================================================
# Next.js Static Export - Apache Configuration
# ================================================

# Enable Rewrite Engine
RewriteEngine On
RewriteBase /

# Allow access to all files by default
<FilesMatch ".*">
    Require all granted
</FilesMatch>

# ================================================
# HTTPS Redirect (Optional - Uncomment in production)
# ================================================
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ================================================
# Next.js Static Routes Handling
# ================================================

# Serve .html files without extension
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.html -f
RewriteRule ^(.+)$ $1.html [L,QSA]

# Remove trailing slashes (except for directories)
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} (.+)/$
RewriteRule ^ %1 [R=301,L]

# ================================================
# Admin Panel - Client Side Routing
# ================================================
# Redirect /admin and /admin/ to /admin.html
RewriteCond %{REQUEST_URI} ^/admin/?$
RewriteRule ^admin/?$ /admin.html [L]

# Route all admin/* subpages to admin.html for client-side routing
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} ^/admin/
RewriteRule ^admin/.+ /admin.html [L]

# ================================================
# Public Pages - Static HTML
# ================================================
# Handle public pages with .html extension
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/_next/
RewriteCond %{REQUEST_URI} !^/admin
RewriteRule ^([^/]+)$ $1.html [L,QSA]

# ================================================
# 404 Error Handling
# ================================================
ErrorDocument 404 /404.html

# ================================================
# Security Headers
# ================================================
<IfModule mod_headers.c>
    # Prevent clickjacking attacks
    Header always set X-Frame-Options "SAMEORIGIN"

    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"

    # Enable XSS protection in browsers
    Header always set X-XSS-Protection "1; mode=block"

    # Referrer policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Permissions policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# ================================================
# Compression (Gzip)
# ================================================
<IfModule mod_deflate.c>
    # Compress HTML, CSS, JavaScript, Text, XML
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE text/plain

    # Compress fonts
    AddOutputFilterByType DEFLATE font/woff
    AddOutputFilterByType DEFLATE font/woff2
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE application/font-woff
    AddOutputFilterByType DEFLATE application/font-woff2
    AddOutputFilterByType DEFLATE application/x-font-woff
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/x-font-otf

    # Compress SVG
    AddOutputFilterByType DEFLATE image/svg+xml

    # Browser compatibility
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
</IfModule>

# ================================================
# Browser Caching
# ================================================
<IfModule mod_expires.c>
    ExpiresActive On

    # HTML - No cache (for dynamic routing)
    ExpiresByType text/html "access plus 0 seconds"

    # Next.js static assets (immutable with hash)
    # Files in _next/static/ have content hashes, cache forever
    <FilesMatch "^.*\/_next\/static\/.*$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # CSS and JavaScript (1 year)
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType application/x-javascript "access plus 1 year"

    # Images (1 year)
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"

    # Fonts (1 year)
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    ExpiresByType application/x-font-woff "access plus 1 year"
    ExpiresByType application/x-font-ttf "access plus 1 year"
    ExpiresByType application/x-font-otf "access plus 1 year"

    # JSON (no cache)
    ExpiresByType application/json "access plus 0 seconds"
</IfModule>

# ================================================
# Cache Control Headers
# ================================================
<IfModule mod_headers.c>
    # HTML files - no cache
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>

    # Next.js build files - immutable
    <FilesMatch "^.*\/_next\/.*\.(js|css|woff|woff2|ttf|otf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # Images - 1 year cache
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico)$">
        Header set Cache-Control "public, max-age=31536000"
    </FilesMatch>
</IfModule>

# ================================================
# Security - Prevent Access to Hidden Files (except .well-known)
# ================================================
<IfModule mod_rewrite.c>
    # Allow .well-known directory (for SSL certificates)
    RewriteCond %{REQUEST_URI} !^/\.well-known/
    # Block access to other hidden files and directories (starting with .)
    RewriteRule "(^|/)\." - [F]
</IfModule>

# ================================================
# Directory Access & Options
# ================================================
Options -Indexes +FollowSymLinks

# ================================================
# Default Charset
# ================================================
AddDefaultCharset UTF-8

# ================================================
# MIME Types
# ================================================
AddType application/javascript .js
AddType text/css .css
AddType image/svg+xml .svg .svgz
AddType font/woff .woff
AddType font/woff2 .woff2
AddType font/ttf .ttf
AddType font/otf .otf
AddType application/json .json

# ================================================
# Custom Error Pages
# ================================================
ErrorDocument 404 /404.html
ErrorDocument 500 /404.html

# ================================================
# ETags (Optional - for better caching)
# ================================================
<IfModule mod_headers.c>
    # Remove ETags for static resources
    <FilesMatch "\.(js|css|jpg|jpeg|png|gif|svg|woff|woff2)$">
        Header unset ETag
    </FilesMatch>
</IfModule>
FileETag None
